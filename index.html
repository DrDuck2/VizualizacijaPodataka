<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <link rel="stylesheet" href="styles.css">
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <title>Projekt</title>
</head>

<body>
    <div class="navbar">
        <a class = "active" href="#home">Home</a>
        <a href = "#news">News</a>
        <a href ="#contact">Contact</a>
        <a href = "#about">About</a>
    </div>
    <div id="chart-container">
        <div id="chart"></div>
        <div id="comparison-container">
            <div id="comparison-block"></div>
        </div>
        <div id="addons-container">
            <div id = "addons-block">
                <div id="slider-container">
                    <input type="range" min="2010" max="2020" value="2010" class="slider" id="year-slider">
                    <span id="selected-year">2010</span>
                </div>
                <div id="selector-comparison">
                    <div class="selector" id="selector1">Select Country 1</div>
                    <div class="selector" id="selector2">Select Country 2</div>
                    <button type="button">Compare</button>
                </div>
            </div>
        </div>
    </div>

    <script>

        var width = 1000;
        var height = 1200;

        var skala = d3.scale.linear()
            .domain([50000, 800000])
            .range([0, 6]);

        // Define the projection for Europe map
        var projection = d3.geo.mercator()
            .center([30, 40]) // Center of Europe
            .scale(500) // Scale for Europe map
            .translate([width / 2, height / 2])

        var path = d3.geo.path()
            .projection(projection);

        var svg = d3.select("#chart")
                .append("svg")
                .attr("width", 850)
                .attr("height", 753.5)
                .style("background", "#f0f0f0") // Light gray background
                .append("g");

            var legend = svg.append("g")
                .attr("class", "legend")
                .attr("transform", "translate(" + 700 + ", 30)")
                .selectAll("g")
                .data(["0%-19%", "20%-39%", "40%-59%", "60%-79%", "80%-100%"])
                .enter().append("g")
                .attr("transform", function(d, i) { return "translate(10," + (i * 20 + 10) + ")"; });

            legend.append("rect")
                .attr("width", 10)
                .attr("height", 10)
                .style("fill", function(d, i) { 
                    return ["red", "orange", "yellow", "lightgreen", "darkgreen"][i];
                });

            legend.append("text")
                .attr("x", 20)
                .attr("y", 5)
                .attr("dy", ".35em")
                .style("font-size","12px")
                .text(function(d) { return d; });

            svg.select(".legend")
                .append("text")
                .attr("y", -10)
                .attr("x", -55)
                .text("Renewable Energy Percentage")
                .style("font-size", "14px");

        // Load the Europe TopoJSON data
        d3.json("europe_topology.json", function(error, europe) {
            if (error) throw error; 

            // Extract the features from the TopoJSON
            var countries = topojson.feature(europe, europe.objects.europe);

            // Load your data with renewable energy percentages
            d3.json("renewable_energy_percentage_data.json", function(error, data) {
                if (error) throw error;

                // Define the custom color scale based on your ranges
                var colorScale = d3.scale.linear()
                    .domain([0, 25, 50, 75, 100,]) // Range of renewable energy percentages (0 to 100)
                    .range(["red", "orange", "yellow", "lightgreen", "darkgreen"]); // Custom color range

                // Draw the countries and apply colors based on renewable energy percentages
                var drawMap = function(year) {
                    svg.selectAll(".country")
                        .data(countries.features)
                        .enter().append("path")
                        .attr("class", "country")
                        .attr("d", function(d) { return path(d.geometry); }) // Use your projection path function
                        .style("fill", function(d) {
                            // Find the corresponding data entry for the country and selected year
                            var countryData = data.find(function(entry) {
                                return entry.Entity === d.properties.NAME && entry.Year === year;
                            });
                            // If data is found, use the color scale to determine the fill color based on renewable percentage
                            return countryData ? colorScale(countryData['Renewable Energy Percentage']) : 'gray'; // Default to gray if data not found
                        })
                        .style("stroke", "#999") // Gray border color
                        .style("stroke-width", 1) // Border width
                        .style("stroke-opacity", 1)
                        .on("mouseover", function(d){
                            handleMouseOver(d.properties.NAME);
                        })
                        .on("mouseout", handleMouseOut)
                        .on("click", function(d) { 
                            drawGraphs(d.properties.NAME);
                        });
                };


                // Initial draw with default year
                drawMap(2010);

                // Add event listener to the slider
                d3.select("#year-slider").on("input", function() {
                    var selectedYear = +this.value; // Get the selected year from the slider
                    d3.select("#selected-year").text(selectedYear); // Update the displayed year

                    svg.selectAll(".country").remove();

                    // Redraw map with new colors based on selected year
                    drawMap(selectedYear);
                });
                
                function handleMouseOver(name) {

                    var tooltip = svg.append("text")
                        .attr("class", "tooltip")
                        .text(name)
                        .style("fill", "black")
                        .style("background-color", "white")
                        .style("pointer-events", "none")
                        .attr("x", d3.event.pageX + 5)
                        .attr("y", d3.event.pageY - 5);

                    svg.on("mousemove", function() {
                        var coordinates = d3.mouse(this);
                        var x = coordinates[0] + 5; // Add offset
                        var y = coordinates[1] - 5; // Subtract offset
                        tooltip.attr("x", x)
                            .attr("y", y);
                    })
                }

                function handleMouseOut() {
                    // Remove the tooltip when mouse moves out
                    d3.select(".tooltip").remove()
                }

                function drawGraph(sentData, query, yText){
                    let elementWidth = 600;
                    let elementHeight = 400;
                    let margin = { top: 20, right: 20, bottom: 70, left: 100 };
                    let width = elementWidth - margin.left - margin.right ;
                    let height = elementHeight - margin.top - margin.bottom;

                    let svg = d3.select(".graphs")
                        .append("svg")
                        .attr("class","graph")
                        .attr("width", elementWidth)
                        .attr("height", elementHeight)
                        .append("g")
                        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                        var x = d3.scale.linear()
                            .domain([2010, 2020]) // Range of years
                            .range([0, width]);
                        var y = d3.scale.linear()
                            .domain([d3.min(sentData, function(d) { return parseFloat(d[query]);}), d3.max(sentData, function(d) { return d[query]; })])
                            .nice()
                            .range([height, 0]);

                        var valueline = d3.svg.line()
                            .x(function(d) {return x(d.Year)})
                            .y(function(d) {return y(d[query]); });

                        svg.append("path")
                            .datum(sentData)
                            .attr("class", "line")
                            .attr("d",valueline)
                            .attr("fill","none")
                            .attr("stroke","black");

                        var xAxis = d3.svg.axis()
                            .scale(x)
                            .orient("bottom")
                            .ticks(11)
                            .tickFormat(d3.format("d"));


                        var yAxis = d3.svg.axis()
                            .scale(y)
                            .orient("left")
                            .ticks(6);

                        svg.append("g")
                            .attr("class","axis")
                            .attr("transform", "translate(0," + height + ")")
                            .call(xAxis);

                            
                        svg.append("g")
                            .attr("class", "axis")
                            .call(yAxis);

                        svg.append("text")
                            .attr("transform", "translate(" + (width / 2) + " ," + (height + margin.bottom -10) + ")")
                            .style("text-anchor", "middle")
                            .text("Godine");

                        svg.append("text")
                            .attr("transform", "rotate(-90)")
                            .attr("y", 0 - margin.left + 10)
                            .attr("x", 0 - (height / 2))
                            .attr("dy", "1em")
                            .style("text-anchor", "middle")
                            .text(yText);
                }

                function drawGraphs(name){
                    

                    d3.selectAll(".graph").remove();

                    var graphContainer = d3.select("#graph-container");

                    if(graphContainer.empty()){
                        var body = d3.select("body")
                            .append("div")
                            .attr("id","graph-container");

                        var svg = d3.select("#graph-container")
                            .append("div")
                            .attr("class", "graphs")
                            .attr("width", 2000)
                            .attr("height",2000);
                    }


                    d3.json("poverty_index_data.json", function(error, poverty_data) {
                        if (error) throw error;
                        
                        var countryData = data.filter(function(d) {
                            return d.Entity === name
                        })

                        var povertyData = poverty_data.filter(function (d) {
                            return d.Entity === name
                        })

                        graphContainer = d3.select("#graph-container");
                        
                        if(d3.select(".close-button").empty()){
                            graphContainer.append("svg")
                            .attr("class", "close-button")
                            .attr("width", 20)
                            .attr("height", 20)
                            .style("position", "absolute")
                            .style("top", "20px")
                            .style("right", "20px")
                            .append("text")
                            .attr("x", 10)
                            .attr("y", 15)
                            .attr("text-anchor", "middle")
                            .style("font-size", "16px")
                            .text("X")
                            .on("click", function () {
                                graphContainer.remove();
                            });
                        }
                    

                        //Renewable Energy Percentage graph
                        drawGraph(countryData, 'Renewable Energy Percentage', "Postotak Obnovljive Energije [%]");

                        //gdp_growth graph
                        drawGraph(povertyData, 'gdp_growth', "Porast/Smanjenje GDP godišnje [%]");

                        //gdp_per_capita graph
                        drawGraph(povertyData, 'gdp_per_capita', "Godisnji GDP [EUR]");
                        
                        const element = document.getElementById("graph-container");
                        element.scrollIntoView({behavior:"smooth"});
                
                    });
                }

                function createEmptyBarChart(container, chartWidth, chartHeight, numBars) {
                    var margin = { top: 20, right: 20, bottom: 70, left: 40 },
                    width = chartWidth - margin.left - margin.right,
                    height = chartHeight - margin.top - margin.bottom;

                    var barPadding = 4;
                    var barWidth = width / numBars - barPadding;

                    // Scales for x and y axes
                    var x = d3.scale.ordinal()
                        .domain(d3.range(numBars))
                        .rangeRoundBands([0, width]);

                    var y = d3.scale.linear()
                        .domain([0, 1])  // Set initial y-domain to 0 to 1 for empty bars
                        .range([height, 0]);

                    // Create the SVG container and set the origin
                    var svg = d3.select(container)
                        .append("svg")
                        .attr("width", chartWidth)
                        .attr("height", chartHeight)
                        .append("g")
                        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                    // Add the x-axis
                    var xAxis = d3.svg.axis()
                        .scale(x)
                        .orient("bottom")
                        .tickFormat(function(d, i) { return i + 1; });

                    svg.append("g")
                        .attr("class", "x axis")
                        .attr("transform", "translate(0," + height + ")")
                        .call(xAxis)
                        .selectAll("text")
                        .style("text-anchor", "middle");

                    // Add the y-axis
                    var yAxis = d3.svg.axis()
                        .scale(y)
                        .orient("left")
                        .ticks(10);

                    svg.append("g")
                        .attr("class", "y axis")
                        .call(yAxis)
                        .append("text")
                        .attr("transform", "rotate(-90)")
                        .attr("y", 6)
                        .attr("dy", ".71em")
                        .style("text-anchor", "end")
                        .text("Vrijednost");

                    // Create the bars (initially with height 0)
                    svg.selectAll("rect")
                        .data(d3.range(numBars))
                        .enter()
                        .append("rect")
                        .attr("x", function(d, i) { return x(i); })
                        .attr("y", height)
                        .attr("height", 0)
                        .attr("width", barWidth);
                }

                createEmptyBarChart("#comparison-block", 600, 753.5/2, 10);
                createEmptyBarChart("#comparison-block", 600, 753.5/2, 10);
                
            });
        });

        function onZoom() {
            svg.attr( "transform", "translate (" + d3.event.translate + ") scale (" + d3.event.scale + ")" );
        }

    </script>
</body>
</html>




